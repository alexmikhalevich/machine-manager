FROM python:3.7-alpine

LABEL maintainer="Carlo Fragni <carlo@cartesi.io>"

# Install python and other dependencies
RUN apk add --no-cache openssl musl-dev python3-dev gcc g++ libc-dev

ENV BASE=/opt/machine-manager
ENV EMU_BASE=$BASE/machine-emulator

# Changing directory to base
WORKDIR $BASE

# Installing python dependencies
COPY requirements.txt $BASE/
RUN pip3 install -r $BASE/requirements.txt

COPY . $BASE
COPY ./machine-emulator $EMU_BASE

EXPOSE 50051

# Making grpc/protobuf autogenerated python code files
RUN \
    cd $EMU_BASE/lib/grpc-interfaces && \
    /bin/sh generate_python_grpc_code.sh

CMD [ "ash", "-c", "python3 mock_manager_server.py -a 0.0.0.0" ]
